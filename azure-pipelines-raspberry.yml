# Azure DevOps Pipeline für MthBdeIotClient - Raspberry Pi 3+ Build
# Optimierte Pipeline für Raspberry Pi ARMv7l .deb Pakete - Basierend auf v1.0.49
# Korrigierte GitHub-Links und Groß-/Kleinschreibung

trigger:
  branches:
    exclude:
      - "*"  # Keine Branch-Trigger
  tags:
    include:
      - "v*"  # Nur bei Tags die mit "v" beginnen

# Deaktiviere auch Pull Request Triggers  
pr: none

variables:
  # Build-Konfiguration
  buildConfiguration: "Release"
  nodeVersion: "22.x"
  
  # Versioning
  isRelease: $[startsWith(variables['Build.SourceBranch'], 'refs/tags/v')]
  releaseVersion: $[replace(variables['Build.SourceBranchName'], 'v', '')]
  
  # Artifact Names
  artifactName: "MthBdeIotClient-RaspberryPi"
  
  # GitHub Configuration
  githubRepository: "mthitservice/MTHBDEIOTClient"
  githubConnection: "github-connection"

stages:
  - stage: Build
    displayName: "Build Raspberry Pi Application"
    jobs:
      - job: BuildRaspberryPi
        displayName: "Build Electron App für Raspberry Pi 3+"
        pool:
          vmImage: "ubuntu-latest"
        
        steps:
          - checkout: self
            fetchDepth: 0
            persistCredentials: true
            displayName: "Checkout Source Code"

          - task: NodeTool@0
            displayName: "Install Node.js $(nodeVersion)"
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: "Cache node modules"
            inputs:
              key: 'npm | "$(Agent.OS)" | App/package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: App/node_modules

          - script: |
              cd App
              echo "=== SYSTEM INFORMATION ==="
              echo "Node version: $(node --version)"
              echo "NPM version: $(npm --version)"
              echo "Working directory: $(pwd)"
              echo "Available memory: $(free -h)"
              echo "Disk space: $(df -h)"
              
              echo "=== PROJECT VERIFICATION ==="
              echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"
              echo "Package-lock.json exists: $(test -f package-lock.json && echo 'YES' || echo 'NO')"
              
              echo "=== NPM CONFIGURATION ==="
              npm config set fund false
              npm config set audit false
              npm config set progress false
              npm config list
            displayName: "System Information & NPM Setup"

          - script: |
              cd App
              echo "=== INSTALLING DEPENDENCIES ==="
              echo "Starting npm install at $(date)"
              
              # Clean install
              npm ci --ignore-scripts --no-audit --no-fund
              
              echo "=== VERIFYING CRITICAL PACKAGES ==="
              echo "dotenv-cli: $(npx dotenv-cli --version || echo 'NOT INSTALLED')"
              echo "cross-env: $(npx cross-env --version || echo 'NOT INSTALLED')"
              echo "electron-builder: $(npx electron-builder --version || echo 'NOT INSTALLED')"
              
              echo "Dependencies installed successfully at $(date)"
            displayName: "Install Dependencies"
            timeoutInMinutes: 10

          - script: |
              cd App
              echo "=== SETTING VERSION ==="
              
              # Version aus Tag oder automatisch generieren
              if [ "$ISRELEASE" = "True" ]; then
                VERSION="$RELEASEVERSION"
                echo "Release Version: $VERSION"
              else
                BUILD_NUMBER="$BUILD_BUILDNUMBER"
                SHORT_COMMIT=$(echo "$BUILD_SOURCEVERSION" | cut -c1-7)
                VERSION="1.0.0-dev.$BUILD_NUMBER+$SHORT_COMMIT"
                echo "Development Version: $VERSION"
              fi

              # Environment Variables setzen
              echo "##vso[task.setvariable variable=APP_VERSION]$VERSION"
              echo "##vso[task.setvariable variable=NODE_ENV]production"
              echo "##vso[task.setvariable variable=ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES]true"

              # Package.json Version aktualisieren
              node -e "
                const fs = require('fs');
                const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
                packageJson.version = '$VERSION';
                fs.writeFileSync('package.json', JSON.stringify(packageJson, null, 2));
                console.log('Updated package.json version to: $VERSION');
              "
              
              echo "Version set to: $VERSION"
            displayName: "Set Application Version"

          - script: |
              cd App
              echo "=== BUILDING APPLICATION ==="
              
              # Environment Variables für Build
              export NODE_ENV=production
              export APP_VERSION=$(APP_VERSION)
              export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true
              
              echo "Building main process..."
              npm run build:main
              
              echo "Building renderer process..."
              npm run build:renderer
              
              echo "=== BUILD VERIFICATION ==="
              if [ -d "dist" ]; then
                echo "✅ Dist folder created"
                echo "Main files: $(find dist -name "*.js" | wc -l) JS files"
                echo "Total files: $(find dist -type f | wc -l) files"
              else
                echo "❌ No dist folder found"
                exit 1
              fi
              
              echo "Application build completed successfully"
            displayName: "Build Application"
            env:
              NODE_ENV: production
              APP_VERSION: $(APP_VERSION)
              ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true

          - script: |
              cd App
              echo "=== PACKAGING RASPBERRY PI DEB ==="
              
              # Environment Variables
              export NODE_ENV=production
              export APP_VERSION=$(APP_VERSION)
              export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true
              export ELECTRON_BUILDER_CACHE_DIR=/tmp/.electron-builder-cache
              
              # Erstelle .env file wenn nicht vorhanden
              if [ ! -f ".env" ]; then
                echo "Creating .env file..."
                echo "NODE_ENV=production" > .env
                echo "APP_VERSION=$(APP_VERSION)" >> .env
                echo "ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true" >> .env
              fi
              
              echo "Running Raspberry Pi DEB packaging..."
              npm run package:raspberry-deb
              
              echo "=== ENHANCED DEB PACKAGE VALIDATION ==="
              # Detaillierte Validierung aller .deb Dateien
              for debfile in $(find . -name "*.deb"); do
                echo "Validating: $debfile"
                
                # Dateigröße prüfen
                size=$(stat -c%s "$debfile")
                echo "  File size: $size bytes ($(echo "scale=2; $size/1024/1024" | bc) MB)"
                
                # Mindestgröße für Electron App (sollte > 30MB sein)
                if [ $size -lt 30000000 ]; then
                  echo "  ⚠️  WARNING: File is unusually small for Electron app"
                fi
                
                # Dateityp prüfen
                filetype=$(file "$debfile")
                echo "  File type: $filetype"
                
                # Prüfe ob es ein Debian-Archiv ist
                if [[ "$filetype" == *"Debian"* ]]; then
                  echo "  ✅ File is recognized as Debian package"
                else
                  echo "  ❌ File is NOT recognized as Debian package"
                fi
                
                # Versuche dpkg-deb validation
                if dpkg-deb --info "$debfile" > /dev/null 2>&1; then
                  echo "  ✅ dpkg-deb validation successful"
                  echo "  Package info:"
                  dpkg-deb --info "$debfile" | head -20
                else
                  echo "  ❌ dpkg-deb validation FAILED"
                  echo "  This will cause 'not a Debian format archive' error"
                fi
                
                # Versuche ar-archiv test
                if ar t "$debfile" > /dev/null 2>&1; then
                  echo "  ✅ ar archive validation successful"
                  echo "  Archive contents:"
                  ar t "$debfile"
                else
                  echo "  ❌ ar archive validation FAILED"
                fi
                
                echo "  ----------------------------------------"
              done
              
              echo "Raspberry Pi packaging completed"
            displayName: "Package Raspberry Pi DEB"
            env:
              NODE_ENV: production
              APP_VERSION: $(APP_VERSION)
              ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true
              ELECTRON_BUILDER_CACHE_DIR: /tmp/.electron-builder-cache

          - task: CopyFiles@2
            displayName: "Copy Raspberry Pi Packages"
            inputs:
              sourceFolder: "App/release"
              contents: "**/*.deb"
              targetFolder: "$(Build.ArtifactStagingDirectory)/packages"
              flattenFolders: false

          - task: CopyFiles@2
            displayName: "Copy Installation Files"
            inputs:
              sourceFolder: "App"
              contents: |
                RASPBERRY_INSTALLATION.md
                deploy.ps1
                generate-inventory.sh
                Dockerfile.raspberry
                *.md
              targetFolder: "$(Build.ArtifactStagingDirectory)/installation"

          - script: |
              echo "=== FINAL PACKAGE VERIFICATION ==="
              echo "Staging directory contents:"
              find $(Build.ArtifactStagingDirectory) -type f -exec ls -lh {} \;
              
              echo "=== PACKAGE SUMMARY ==="
              deb_count=$(find $(Build.ArtifactStagingDirectory) -name "*.deb" | wc -l)
              echo "DEB packages found: $deb_count"
              
              if [ $deb_count -gt 0 ]; then
                echo "✅ Raspberry Pi DEB package created successfully"
                find $(Build.ArtifactStagingDirectory) -name "*.deb" -exec basename {} \;
              else
                echo "❌ No DEB packages found"
                echo "Available files:"
                find $(Build.ArtifactStagingDirectory) -type f
              fi
            displayName: "Verify Packages"

          - task: PublishBuildArtifacts@1
            displayName: "Publish Raspberry Pi Artifacts"
            inputs:
              pathToPublish: "$(Build.ArtifactStagingDirectory)"
              artifactName: $(artifactName)
              publishLocation: "Container"
            condition: always()

  - stage: Release
    displayName: "Release Raspberry Pi Package"
    condition: and(succeeded(), eq(variables.isRelease, true))
    dependsOn: Build
    jobs:
      - deployment: RaspberryPiRelease
        displayName: "Create Raspberry Pi Release"
        environment: "RaspberryPi-Production"
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  displayName: "Download Build Artifacts"

                - script: |
                    echo "=== RELEASE INFORMATION ==="
                    echo "Version: $(releaseVersion)"
                    echo "Build Number: $(Build.BuildNumber)"
                    echo "Commit: $(Build.SourceVersion)"
                    echo "Branch: $(Build.SourceBranch)"
                    
                    echo "=== AVAILABLE ARTIFACTS ==="
                    find $(Pipeline.Workspace) -name "*.deb" -exec ls -lh {} \;
                  displayName: "Release Information"

  - stage: GitHubDeploy
    displayName: "Deploy to GitHub Repository"
    condition: and(succeeded(), eq(variables.isRelease, true))
    dependsOn: Release
    jobs:
      - deployment: DeployToGitHub
        displayName: "Deploy DEB to GitHub releases folder"
        environment: "GitHub-Production"
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  displayName: "Download Build Artifacts"

                - task: PowerShell@2
                  displayName: "Detect Actual DEB Filename"
                  inputs:
                    targetType: "inline"
                    script: |
                      $workspacePath = "$(Pipeline.Workspace)/MthBdeIotClient-RaspberryPi"
                      $version = "$(releaseVersion)"
                      
                      Write-Host "=== DEB FILENAME DETECTION ==="
                      Write-Host "Workspace: $workspacePath"
                      Write-Host "Version: $version"
                      
                      # Debug: Zeige komplette Ordnerstruktur
                      Write-Host "=== WORKSPACE STRUCTURE ==="
                      if (Test-Path $workspacePath) {
                          Get-ChildItem -Path $workspacePath -Recurse | ForEach-Object {
                              Write-Host "  $($_.FullName)"
                          }
                      } else {
                          Write-Host "❌ Workspace path does not exist: $workspacePath"
                      }
                      
                      # Erweiterte Suche nach DEB-Dateien
                      $searchPaths = @(
                          "$workspacePath/packages",
                          "$workspacePath/installation", 
                          "$workspacePath",
                          "$(Pipeline.Workspace)"
                      )
                      
                      $foundDebFiles = @()
                      
                      foreach ($searchPath in $searchPaths) {
                          if (Test-Path $searchPath) {
                              Write-Host "Searching in: $searchPath"
                              $debFiles = Get-ChildItem -Path $searchPath -Filter "*.deb" -Recurse -ErrorAction SilentlyContinue
                              foreach ($file in $debFiles) {
                                  $foundDebFiles += $file
                                  Write-Host "  Found: $($file.Name) (Size: $([math]::Round($file.Length/1MB, 2)) MB)"
                              }
                          } else {
                              Write-Host "Path does not exist: $searchPath"
                          }
                      }
                      
                      if ($foundDebFiles.Count -eq 0) {
                          Write-Host "❌ ERROR: No DEB files found!"
                          Write-Host "Available artifacts:"
                          Get-ChildItem -Path "$(Pipeline.Workspace)" -Recurse | Where-Object {$_.Name -like "*.deb" -or $_.Name -like "*.tar.gz"} | ForEach-Object {
                              Write-Host "  $($_.FullName)"
                          }
                          exit 1
                      }
                      
                      # Wähle das erste/größte DEB-File
                      $selectedDebFile = $foundDebFiles | Sort-Object Length -Descending | Select-Object -First 1
                      $debFileName = $selectedDebFile.Name
                      
                      Write-Host "=== SELECTED DEB FILE ==="
                      Write-Host "Filename: $debFileName"
                      Write-Host "Full Path: $($selectedDebFile.FullName)"
                      Write-Host "Size: $([math]::Round($selectedDebFile.Length/1MB, 2)) MB"
                      
                      # Setze Pipeline-Variable
                      Write-Host "##vso[task.setvariable variable=ACTUAL_DEB_FILENAME]$debFileName"
                      Write-Host "##vso[task.setvariable variable=ACTUAL_DEB_FULLPATH]$($selectedDebFile.FullName)"
                      Write-Host "✅ DEB filename detected: $debFileName"

                - script: |
                    echo "=== PREPARING RELEASE FILES ==="
                    
                    workspace="$(Pipeline.Workspace)/MthBdeIotClient-RaspberryPi"
                    temp_releases="$(Agent.TempDirectory)/releases"
                    
                    # Erstelle releases Ordnerstruktur
                    mkdir -p "$temp_releases/latest"
                    mkdir -p "$temp_releases/v$(releaseVersion)"
                    mkdir -p "$temp_releases/update"
                    
                    # Verwende den vollständigen Pfad zur DEB-Datei
                    actual_deb_file="$(ACTUAL_DEB_FULLPATH)"
                    
                    if [ -n "$actual_deb_file" ] && [ -f "$actual_deb_file" ]; then
                      actual_deb_filename=$(basename "$actual_deb_file")
                      echo "=== COPYING DEB FILE: $actual_deb_filename ==="
                      echo "Source: $actual_deb_file"
                      
                      # Kopiere zu allen Zielordnern
                      cp "$actual_deb_file" "$temp_releases/latest/"
                      cp "$actual_deb_file" "$temp_releases/v$(releaseVersion)/"
                      cp "$actual_deb_file" "$temp_releases/update/"
                      
                      # Erstelle Checksums
                      cd "$temp_releases/latest"
                      sha256sum *.deb > SHA256SUMS
                      
                      cd "$temp_releases/v$(releaseVersion)"
                      sha256sum *.deb > SHA256SUMS
                      
                      cd "$temp_releases/update"
                      sha512sum *.deb > SHA512SUMS
                      
                      # Erstelle latest.yml für AutoUpdater
                      deb_file=$(ls *.deb | head -1)
                      file_size=$(stat -c%s "$deb_file")
                      deb_sha512=$(sha512sum "$deb_file" | cut -d' ' -f1)
                      
                      cat > latest.yml << EOF
                      version: $(releaseVersion)
                      files:
                        - url: $deb_file
                          sha512: $deb_sha512
                          size: $file_size
                      path: $deb_file
                      sha512: $deb_sha512
                      releaseDate: $(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
                      EOF
                      
                      echo "✅ Release files prepared successfully"
                    else
                      echo "❌ ERROR: DEB file not found at expected location!"
                      echo "Expected: $actual_deb_file"
                      echo "Fallback search in workspace:"
                      find "$workspace" -name "*.deb" -type f | head -5
                      exit 1
                    fi
                  displayName: "Prepare Release Files"

                - task: PowerShell@2
                  displayName: "Create Release README"
                  inputs:
                    targetType: "inline"
                    script: |
                      $version = "$(releaseVersion)"
                      $debFileName = "$(ACTUAL_DEB_FILENAME)"
                      $today = Get-Date -Format "dd.MM.yyyy HH:mm"
                      
                      # Korrigierte GitHub-URLs (beachte Groß-/Kleinschreibung)
                      $githubRepo = "$(githubRepository)"
                      
                      $releaseReadme = @"
                      # MthBdeIotClient Raspberry Pi Releases
                      
                      ## Latest Release: v$version
                      
                      **Erstellt:** $today  
                      **DEB-Datei:** $debFileName
                      
                      ### 📦 Schnell-Installation
                      
                      ```bash
                      # Eine Zeile Installation (automatische Dateinamen-Erkennung)
                      wget -qO- https://raw.githubusercontent.com/$githubRepo/main/install-latest.sh | bash
                      ```
                      
                      ### 📦 Manuelle Installation
                      
                      ```bash
                      # 1. Download (korrekter Dateiname)
                      wget https://github.com/$githubRepo/raw/main/releases/latest/$debFileName
                      
                      # 2. Installation
                      sudo dpkg -i $debFileName
                      
                      # 3. Abhängigkeiten reparieren
                      sudo apt-get install -f
                      
                      # 4. Anwendung starten
                      mthbdeiotclient
                      ```
                      
                      ### 📋 Systemanforderungen
                      - ✅ Raspberry Pi 3, 3+, 4 oder Zero 2 W
                      - ✅ Raspberry Pi OS (32-bit, ARMv7l)
                      - ✅ Mindestens 1GB RAM
                      - ✅ Desktop-Umgebung (X11)
                      
                      ### 🔧 Troubleshooting
                      ```bash
                      # Berechtigungen reparieren
                      sudo chmod +x /usr/bin/mthbdeiotclient
                      
                      # Abhängigkeiten installieren
                      sudo apt-get update && sudo apt-get install -f
                      
                      # Deinstallation
                      sudo dpkg -r mthbdeiotclient
                      ```
                      
                      ### 🔗 Direkte Links
                      - [📦 Latest DEB](https://github.com/$githubRepo/raw/main/releases/latest/$debFileName)
                      - [📋 SHA256SUMS](https://github.com/$githubRepo/raw/main/releases/latest/SHA256SUMS)
                      - [🔄 AutoUpdater Config](https://github.com/$githubRepo/raw/main/releases/update/latest.yml)
                      
                      ---
                      **Architektur:** ARMv7l | **Format:** DEB | **Build:** Azure DevOps
                      "@
                      
                      $releaseReadme | Out-File -FilePath "$(Agent.TempDirectory)/releases/README.md" -Encoding UTF8
                      Write-Host "✅ Release README created"

                - task: PowerShell@2
                  displayName: "Deploy to GitHub"
                  inputs:
                    targetType: "inline"
                    script: |
                      # Git konfigurieren
                      git config --global user.email "azure-devops@mth-it-service.com"
                      git config --global user.name "Azure DevOps Pipeline"
                      
                      # Repository klonen
                      $githubToken = "$(GITHUB_TOKEN)"
                      if ([string]::IsNullOrEmpty($githubToken)) {
                          Write-Host "❌ ERROR: GITHUB_TOKEN nicht gesetzt!"
                          exit 1
                      }
                      
                      $repoUrl = "https://$githubToken@github.com/$(githubRepository).git"
                      git clone $repoUrl repo-clone --quiet
                      
                      # Zu Repository wechseln
                      cd repo-clone
                      
                      # Releases Ordner erstellen
                      if (-not (Test-Path "releases")) {
                          New-Item -ItemType Directory -Path "releases"
                      }
                      
                      # Release-Dateien kopieren
                      $tempReleases = "$(Agent.TempDirectory)/releases"
                      Copy-Item -Path "$tempReleases/*" -Destination "releases/" -Recurse -Force
                      
                      # Git add, commit und push
                      git add releases/
                      git commit -m "Release v$(releaseVersion) - Add Raspberry Pi DEB package $(ACTUAL_DEB_FILENAME)"
                      git push origin main
                      
                      Write-Host "✅ Successfully deployed to GitHub"

                - script: |
                    echo "=========================================="
                    echo "🚀 GITHUB DEPLOY COMPLETED"
                    echo "=========================================="
                    echo ""
                    echo "✅ Status: SUCCESS"
                    echo "📦 Version: $(releaseVersion)"
                    echo "📁 DEB-Datei: $(ACTUAL_DEB_FILENAME)"
                    echo ""
                    echo "🔗 KORREKTE LINKS (beachte Groß-/Kleinschreibung):"
                    echo "Latest DEB: https://github.com/$(githubRepository)/raw/main/releases/latest/$(ACTUAL_DEB_FILENAME)"
                    echo "SHA256SUMS: https://github.com/$(githubRepository)/raw/main/releases/latest/SHA256SUMS"
                    echo "AutoUpdater: https://github.com/$(githubRepository)/raw/main/releases/update/latest.yml"
                    echo ""
                    echo "🍓 INSTALLATION (korrekter Dateiname):"
                    echo "wget https://github.com/$(githubRepository)/raw/main/releases/latest/$(ACTUAL_DEB_FILENAME)"
                    echo "sudo dpkg -i $(ACTUAL_DEB_FILENAME) && sudo apt-get install -f"
                    echo ""
                    echo "🎉 Release ist verfügbar!"
                    echo "=========================================="
                  displayName: "Deployment Summary"

  - stage: Documentation
    displayName: "Build Summary"
    condition: succeeded()
    dependsOn: 
      - Build
    jobs:
      - job: BuildSummary
        displayName: "Show Build Results"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - script: |
              echo "=========================================="
              echo "🍓 RASPBERRY PI BUILD COMPLETED"
              echo "=========================================="
              echo ""
              echo "✅ Build Status: SUCCESS"
              echo "📦 Artifact: $(artifactName)"
              echo "🎯 Target: Raspberry Pi 3+ (ARMv7l)"
              echo "📋 Format: .deb (Debian Package)"
              echo ""
              if [ "$(isRelease)" = "True" ]; then
                echo "🚀 RELEASE DEPLOYED:"
                echo "📁 Release Folder: https://github.com/$(githubRepository)/tree/main/releases/latest"
                echo ""
                echo "📦 INSTALLATION:"
                echo "wget https://github.com/$(githubRepository)/raw/main/releases/latest/[DEB-FILENAME]"
                echo "sudo dpkg -i [DEB-FILENAME] && sudo apt-get install -f"
                echo ""
              fi
              echo "📖 NEXT STEPS:"
              echo "1. Download artifacts from this build"
              echo "2. Test installation on Raspberry Pi"
              echo "3. Use GitHub release for distribution"
              echo ""
              echo "=========================================="
            displayName: "Build Summary"
