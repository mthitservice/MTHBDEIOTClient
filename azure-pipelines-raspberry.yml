# Azure DevOps Pipeline f√ºr MthBdeIotClient - Raspberry Pi 3+ Build
# Optimierte Pipeline f√ºr Raspberry Pi ARMv7l .deb Pakete

trigger:
  branches:
    include:
      - master
      - release/*
      - develop
  tags:
    include:
      - "v*"

variables:
  # Build-Konfiguration
  buildConfiguration: "Release"
  nodeVersion: "22.x"
  
  # Versioning
  isRelease: $[startsWith(variables['Build.SourceBranch'], 'refs/tags/v')]
  releaseVersion: $[replace(variables['Build.SourceBranchName'], 'v', '')]
  
  # Artifact Names
  artifactName: "MthBdeIotClient-RaspberryPi"
  
  # GitHub Configuration
  githubRepository: "mthitservice/MTHBDEIOTClient"
  githubConnection: "github-connection"

stages:
  - stage: Build
    displayName: "Build Raspberry Pi Application"
    jobs:
      - job: BuildRaspberryPi
        displayName: "Build Electron App f√ºr Raspberry Pi 3+"
        pool:
          vmImage: "ubuntu-latest"

        steps:
          - checkout: self
            fetchDepth: 0
            persistCredentials: true

          - task: NodeTool@0
            displayName: "Install Node.js $(nodeVersion)"
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: "Cache node modules"
            inputs:
              key: 'npm | "$(Agent.OS)" | App/package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: App/node_modules

          - script: |
              cd App
              echo "=== SYSTEM INFORMATION ==="
              echo "Node version: $(node --version)"
              echo "NPM version: $(npm --version)"
              echo "Working directory: $(pwd)"
              echo "Available memory: $(free -h)"
              echo "Disk space: $(df -h)"
              
              echo "=== PROJECT VERIFICATION ==="
              echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"
              echo "Package-lock.json exists: $(test -f package-lock.json && echo 'YES' || echo 'NO')"
              
              echo "=== NPM CONFIGURATION ==="
              npm config set fund false
              npm config set audit false
              npm config set progress false
              npm config list
            displayName: "System Information & NPM Setup"

          - script: |
              cd App
              echo "=== INSTALLING DEPENDENCIES ==="
              echo "Starting npm install at $(date)"
              
              # Clean install
              npm ci --ignore-scripts --no-audit --no-fund
              
              echo "=== VERIFYING CRITICAL PACKAGES ==="
              echo "dotenv-cli: $(npx dotenv-cli --version || echo 'NOT INSTALLED')"
              echo "cross-env: $(npx cross-env --version || echo 'NOT INSTALLED')"
              echo "electron-builder: $(npx electron-builder --version || echo 'NOT INSTALLED')"
              
              echo "Dependencies installed successfully at $(date)"
            displayName: "Install Dependencies"
            timeoutInMinutes: 10

          - script: |
              cd App
              echo "=== SETTING VERSION ==="
              
              # Version aus Tag oder automatisch generieren
              if [ "$ISRELEASE" = "True" ]; then
                VERSION="$RELEASEVERSION"
                echo "Release Version: $VERSION"
              else
                BUILD_NUMBER="$BUILD_BUILDNUMBER"
                SHORT_COMMIT=$(echo "$BUILD_SOURCEVERSION" | cut -c1-7)
                VERSION="1.0.0-dev.$BUILD_NUMBER+$SHORT_COMMIT"
                echo "Development Version: $VERSION"
              fi

              # Environment Variables setzen
              echo "##vso[task.setvariable variable=APP_VERSION]$VERSION"
              echo "##vso[task.setvariable variable=NODE_ENV]production"
              echo "##vso[task.setvariable variable=ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES]true"

              # Package.json Version aktualisieren
              node -e "
                const fs = require('fs');
                const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
                packageJson.version = '$VERSION';
                fs.writeFileSync('package.json', JSON.stringify(packageJson, null, 2));
                console.log('Updated package.json version to: $VERSION');
              "
              
              echo "Version set to: $VERSION"
            displayName: "Set Application Version"

          - script: |
              cd App
              echo "=== BUILDING APPLICATION ==="
              
              # Environment Variables f√ºr Build
              export NODE_ENV=production
              export APP_VERSION=$(APP_VERSION)
              export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true
              
              echo "Building main process..."
              npm run build:main
              
              echo "Building renderer process..."
              npm run build:renderer
              
              echo "=== BUILD VERIFICATION ==="
              if [ -d "dist" ]; then
                echo "‚úÖ Dist folder created"
                echo "Main files: $(find dist -name "*.js" | wc -l) JS files"
                echo "Total files: $(find dist -type f | wc -l) files"
              else
                echo "‚ùå No dist folder found"
                exit 1
              fi
              
              echo "Application build completed successfully"
            displayName: "Build Application"
            env:
              NODE_ENV: production
              APP_VERSION: $(APP_VERSION)
              ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true

          - script: |
              cd App
              echo "=== PACKAGING RASPBERRY PI DEB ==="
              
              # Environment Variables
              export NODE_ENV=production
              export APP_VERSION=$(APP_VERSION)
              export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true
              
              # Erstelle .env file wenn nicht vorhanden
              if [ ! -f ".env" ]; then
                echo "Creating .env file..."
                echo "NODE_ENV=production" > .env
                echo "APP_VERSION=$(APP_VERSION)" >> .env
                echo "ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true" >> .env
              fi
              
              echo "Running Raspberry Pi DEB packaging..."
              npm run package:raspberry-deb
              
              echo "=== PACKAGE VERIFICATION ==="
              echo "Looking for .deb files:"
              find . -name "*.deb" -exec ls -lh {} \; || echo "‚ùå No .deb files found"
              
              echo "Looking for .tar.gz files:"
              find . -name "*.tar.gz" -exec ls -lh {} \; || echo "‚ùå No .tar.gz files found"
              
              echo "Release folder structure:"
              if [ -d "release" ]; then
                find release -type f -name "*.deb" -o -name "*.tar.gz" | head -10
              else
                echo "‚ùå No release folder found"
              fi
              
              echo "Raspberry Pi packaging completed"
            displayName: "Package Raspberry Pi DEB"
            env:
              NODE_ENV: production
              APP_VERSION: $(APP_VERSION)
              ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true

          - task: CopyFiles@2
            displayName: "Copy Raspberry Pi Packages"
            inputs:
              sourceFolder: "App/release"
              contents: "**/*.deb"
              targetFolder: "$(Build.ArtifactStagingDirectory)/packages"
              flattenFolders: false

          - task: CopyFiles@2
            displayName: "Copy Installation Files"
            inputs:
              sourceFolder: "App"
              contents: |
                RASPBERRY_INSTALLATION.md
                deploy.ps1
                generate-inventory.sh
                Dockerfile.raspberry
                *.md
              targetFolder: "$(Build.ArtifactStagingDirectory)/installation"

          - script: |
              echo "=== FINAL PACKAGE VERIFICATION ==="
              echo "Staging directory contents:"
              find $(Build.ArtifactStagingDirectory) -type f -exec ls -lh {} \;
              
              echo "=== PACKAGE SUMMARY ==="
              deb_count=$(find $(Build.ArtifactStagingDirectory) -name "*.deb" | wc -l)
              echo "DEB packages found: $deb_count"
              
              if [ $deb_count -gt 0 ]; then
                echo "‚úÖ Raspberry Pi DEB package created successfully"
                find $(Build.ArtifactStagingDirectory) -name "*.deb" -exec basename {} \;
              else
                echo "‚ùå No DEB packages found"
                echo "Available files:"
                find $(Build.ArtifactStagingDirectory) -type f
              fi
            displayName: "Verify Packages"

          - task: PublishBuildArtifacts@1
            displayName: "Publish Raspberry Pi Artifacts"
            inputs:
              pathToPublish: "$(Build.ArtifactStagingDirectory)"
              artifactName: $(artifactName)
              publishLocation: "Container"
            condition: always()

  - stage: Release
    displayName: "Release Raspberry Pi Package"
    condition: and(succeeded(), eq(variables.isRelease, true))
    dependsOn: Build
    jobs:
      - deployment: RaspberryPiRelease
        displayName: "Create Raspberry Pi Release"
        environment: "RaspberryPi-Production"
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  displayName: "Download Build Artifacts"

                - script: |
                    echo "=== RELEASE INFORMATION ==="
                    echo "Version: $(releaseVersion)"
                    echo "Build Number: $(Build.BuildNumber)"
                    echo "Commit: $(Build.SourceVersion)"
                    echo "Branch: $(Build.SourceBranch)"
                    
                    echo "=== AVAILABLE ARTIFACTS ==="
                    find $(Pipeline.Workspace) -name "*.deb" -exec ls -lh {} \;
                  displayName: "Release Information"

                - task: PowerShell@2
                  displayName: "Generate Release Notes"
                  inputs:
                    targetType: "inline"
                    script: |
                      $version = "$(releaseVersion)"
                      $buildNumber = "$(Build.BuildNumber)"
                      $sourceVersion = "$(Build.SourceVersion)"
                      
                      $releaseNotes = @"
                      # MthBdeIotClient Raspberry Pi Release v$version

                      ## üçì Raspberry Pi 3+ Installation Package

                      ### üì¶ Download:
                      - **Raspberry Pi 3+ (ARMv7l):** ``mthbdeiotclient_$version_armhf.deb``

                      ### üîß Installation auf Raspberry Pi:

                      #### Direkte Installation:
                      ``````bash
                      # Download des DEB Pakets
                      wget https://your-release-url/mthbdeiotclient_$version_armhf.deb

                      # Installation
                      sudo dpkg -i mthbdeiotclient_$version_armhf.deb

                      # Abh√§ngigkeiten reparieren falls n√∂tig
                      sudo apt-get install -f
                      ``````

                      #### Automatische Installation:
                      ``````bash
                      # Schnell-Installation
                      curl -L https://your-release-url/mthbdeiotclient_$version_armhf.deb -o mthbdeiotclient.deb
                      sudo dpkg -i mthbdeiotclient.deb
                      sudo apt-get install -f
                      ``````

                      ### üöÄ Starten der Anwendung:
                      ``````bash
                      # Desktop-Umgebung
                      mthbdeiotclient

                      # Oder √ºber Anwendungsmen√º
                      # Kategorie: Development oder Office
                      ``````

                      ### üìã Systemanforderungen:
                      - Raspberry Pi 3, 3+, 4 oder Zero 2 W
                      - Raspberry Pi OS (32-bit, ARMv7l)
                      - Mindestens 1GB RAM
                      - Desktop-Umgebung (X11)

                      ### üìñ Detaillierte Anweisungen:
                      Siehe [RASPBERRY_INSTALLATION.md](./RASPBERRY_INSTALLATION.md) f√ºr:
                      - Ansible Deployment
                      - Automatische Installation
                      - Konfiguration
                      - Troubleshooting

                      ---
                      **Build:** $buildNumber  
                      **Commit:** $sourceVersion  
                      **Pipeline:** Azure DevOps - Raspberry Pi Specialized  
                      **Architektur:** ARMv7l (32-bit)
                      "@

                      $releaseNotes | Out-File -FilePath "$(Agent.TempDirectory)/raspberry-release-notes.md" -Encoding UTF8
                      Write-Host "Release notes prepared for Raspberry Pi version $version"

                - script: |
                    echo "=== RELEASE PACKAGE SUMMARY ==="
                    
                    workspace="$(Pipeline.Workspace)/MthBdeIotClient-RaspberryPi"
                    echo "Workspace: $workspace"
                    
                    if [ -d "$workspace" ]; then
                      echo "‚úÖ Artifact workspace found"
                      
                      echo "üì¶ DEB Packages:"
                      find "$workspace" -name "*.deb" -exec ls -lh {} \; | while read line; do
                        echo "  $line"
                      done
                      
                      echo "üìÑ Installation Files:"
                      find "$workspace" -name "*.md" -o -name "*.ps1" -o -name "*.sh" | while read file; do
                        echo "  $(basename "$file")"
                      done
                      
                      echo "üìä Total Files: $(find "$workspace" -type f | wc -l)"
                      echo "üìä Package Size: $(du -sh "$workspace" | cut -f1)"
                    else
                      echo "‚ùå Artifact workspace not found"
                      echo "Available directories:"
                      ls -la "$(Pipeline.Workspace)/"
                    fi
                  displayName: "Release Package Summary"

  - stage: GitHubRelease
    displayName: "GitHub Release"
    condition: and(succeeded(), eq(variables.isRelease, true))
    dependsOn: Release
    jobs:
      - deployment: CreateGitHubRelease
        displayName: "Create GitHub Release"
        environment: "GitHub-Production"
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  displayName: "Download Build Artifacts"

                - script: |
                    echo "=== GITHUB RELEASE PREPARATION ==="
                    echo "Version: $(releaseVersion)"
                    echo "Tag: v$(releaseVersion)"
                    echo "Repository: $(githubRepository)"
                    echo "Build: $(Build.BuildNumber)"
                    echo "Commit: $(Build.SourceVersion)"
                    
                    workspace="$(Pipeline.Workspace)/MthBdeIotClient-RaspberryPi"
                    echo "Workspace: $workspace"
                    
                    if [ -d "$workspace" ]; then
                      echo "‚úÖ Artifacts found"
                      echo "üì¶ DEB Files:"
                      find "$workspace" -name "*.deb" -exec ls -lh {} \;
                    else
                      echo "‚ùå Artifacts not found"
                      exit 1
                    fi
                  displayName: "Prepare GitHub Release"

                - task: PowerShell@2
                  displayName: "Generate Release Notes"
                  inputs:
                    targetType: "inline"
                    script: |
                      $version = "$(releaseVersion)"
                      $buildNumber = "$(Build.BuildNumber)"
                      $commit = "$(Build.SourceVersion)".Substring(0, 7)
                      $today = Get-Date -Format "dd.MM.yyyy HH:mm"
                      
                      # Finde DEB-Dateiname
                      $workspace = "$(Pipeline.Workspace)/MthBdeIotClient-RaspberryPi"
                      $debFiles = Get-ChildItem -Path "$workspace/packages" -Filter "*.deb" -ErrorAction SilentlyContinue
                      $debFileName = if ($debFiles) { $debFiles[0].Name } else { "mthbdeiotclient_$($version)_armhf.deb" }
                      
                      $releaseNotes = @"
                      # üçì MthBdeIotClient Raspberry Pi v$version
                      
                      ## Raspberry Pi 3+ Installation Package
                      
                      **Automatisch erstellt:** $today  
                      **Build:** $buildNumber  
                      **Commit:** $commit
                      
                      ### üì¶ Download
                      - **Raspberry Pi 3+ (ARMv7l):** [$debFileName]($debFileName)
                      
                      ### ‚ö° Schnell-Installation
                      ``````bash
                      # Eine Zeile Installation
                      wget https://github.com/$(githubRepository)/releases/latest/download/$debFileName && sudo dpkg -i $debFileName && sudo apt-get install -f
                      ``````
                      
                      ### üîß Schritt-f√ºr-Schritt Installation
                      ``````bash
                      # 1. Download
                      wget https://github.com/$(githubRepository)/releases/latest/download/$debFileName
                      
                      # 2. Installation
                      sudo dpkg -i $debFileName
                      
                      # 3. Abh√§ngigkeiten installieren
                      sudo apt-get install -f
                      
                      # 4. Anwendung starten
                      mthbdeiotclient
                      ``````
                      
                      ### üìã Systemanforderungen
                      - ‚úÖ Raspberry Pi 3, 3+, 4 oder Zero 2 W
                      - ‚úÖ Raspberry Pi OS (32-bit, ARMv7l)
                      - ‚úÖ Mindestens 1GB RAM
                      - ‚úÖ Desktop-Umgebung (X11)
                      
                      ### üîß Troubleshooting
                      ``````bash
                      # Fehlende Abh√§ngigkeiten
                      sudo apt-get update && sudo apt-get install -f
                      
                      # Berechtigungsprobleme
                      sudo chmod +x /usr/bin/mthbdeiotclient
                      
                      # Display-Probleme
                      export DISPLAY=:0 && mthbdeiotclient
                      
                      # Deinstallation
                      sudo dpkg -r mthbdeiotclient
                      ``````
                      
                      ### üìñ Weitere Informationen
                      - [üìã Raspberry Pi Installation Guide](https://github.com/$(githubRepository)/blob/master/App/RASPBERRY_INSTALLATION.md)
                      - [üöÄ Deployment Guide](https://github.com/$(githubRepository)/blob/master/DEPLOYMENT_GUIDE.md)
                      - [‚ùì Issues & Support](https://github.com/$(githubRepository)/issues)
                      
                      ---
                      **üîß Technische Details:**  
                      Architektur: ARMv7l | Package: DEB | Build System: Azure DevOps
                      "@
                      
                      $releaseNotes | Out-File -FilePath "$(Agent.TempDirectory)/release-notes.md" -Encoding UTF8
                      Write-Host "Release notes generated for version $version"
                      
                      # Setze Variablen f√ºr GitHub Release
                      Write-Host "##vso[task.setvariable variable=TAG_NAME]v$version"
                      Write-Host "##vso[task.setvariable variable=DEB_FILENAME]$debFileName"

                - script: |
                    echo "=== PREPARING GITHUB ASSETS ==="
                    
                    workspace="$(Pipeline.Workspace)/MthBdeIotClient-RaspberryPi"
                    assets_path="$(Agent.TempDirectory)/github-assets"
                    
                    # Erstelle Assets-Ordner
                    mkdir -p "$assets_path"
                    
                    # Kopiere DEB-Dateien
                    if [ -d "$workspace/packages" ]; then
                      echo "Copying DEB packages..."
                      cp "$workspace/packages"/*.deb "$assets_path/" 2>/dev/null || echo "No DEB files to copy"
                      
                      # Erstelle SHA256 Checksums
                      cd "$assets_path"
                      if ls *.deb 1> /dev/null 2>&1; then
                        sha256sum *.deb > SHA256SUMS
                        echo "‚úÖ SHA256SUMS created"
                      fi
                    fi
                    
                    # Kopiere Installation Files
                    if [ -d "$workspace/installation" ]; then
                      echo "Copying installation documentation..."
                      cp "$workspace/installation/RASPBERRY_INSTALLATION.md" "$assets_path/" 2>/dev/null || echo "No RASPBERRY_INSTALLATION.md found"
                      cp "$workspace/installation/deploy.ps1" "$assets_path/" 2>/dev/null || echo "No deploy.ps1 found"
                      cp "$workspace/installation/generate-inventory.sh" "$assets_path/" 2>/dev/null || echo "No generate-inventory.sh found"
                    fi
                    
                    echo "‚úÖ GitHub assets prepared:"
                    ls -la "$assets_path"
                  displayName: "Prepare GitHub Assets"

                - task: GitHubRelease@1
                  displayName: "Create GitHub Release"
                  inputs:
                    gitHubConnection: $(githubConnection)
                    repositoryName: $(githubRepository)
                    action: "create"
                    target: "$(Build.SourceVersion)"
                    tagSource: "userSpecifiedTag"
                    tag: "$(TAG_NAME)"
                    title: "MthBdeIotClient Raspberry Pi v$(releaseVersion)"
                    releaseNotesSource: "filePath"
                    releaseNotesFilePath: "$(Agent.TempDirectory)/release-notes.md"
                    assets: "$(Agent.TempDirectory)/github-assets/*"
                    isPreRelease: false
                    isDraft: false
                    changeLogCompareToRelease: "lastFullRelease"
                    changeLogType: "commitBased"

                - script: |
                    echo "=========================================="
                    echo "üöÄ GITHUB RELEASE PUBLISHED"
                    echo "=========================================="
                    echo ""
                    echo "‚úÖ Status: SUCCESS"
                    echo "üè∑Ô∏è Tag: $(TAG_NAME)"
                    echo "üì¶ Version: $(releaseVersion)"
                    echo "üîó Repository: https://github.com/$(githubRepository)"
                    echo "üìã Release: https://github.com/$(githubRepository)/releases/tag/$(TAG_NAME)"
                    echo "üì• Latest: https://github.com/$(githubRepository)/releases/latest"
                    echo ""
                    echo "üì¶ PUBLISHED ASSETS:"
                    echo "- $(DEB_FILENAME)"
                    echo "- SHA256SUMS"
                    echo "- RASPBERRY_INSTALLATION.md"
                    echo "- deploy.ps1"
                    echo "- generate-inventory.sh"
                    echo ""
                    echo "üçì RASPBERRY PI INSTALLATION:"
                    echo "wget https://github.com/$(githubRepository)/releases/latest/download/$(DEB_FILENAME)"
                    echo "sudo dpkg -i $(DEB_FILENAME) && sudo apt-get install -f"
                    echo ""
                    echo "üéâ Release ist jetzt als 'latest' verf√ºgbar!"
                    echo "=========================================="
                  displayName: "GitHub Release Summary"

  - stage: Documentation
    displayName: "Documentation & Next Steps"
    condition: succeeded()
    dependsOn: Build
    jobs:
      - job: DocumentationSummary
        displayName: "Show Next Steps"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - script: |
              echo "=========================================="
              echo "üçì RASPBERRY PI BUILD COMPLETED"
              echo "=========================================="
              echo ""
              echo "‚úÖ Build Status: SUCCESS"
              echo "üì¶ Artifact: $(artifactName)"
              echo "üéØ Target: Raspberry Pi 3+ (ARMv7l)"
              echo "üìã Package: .deb (Debian Package)"
              echo ""
              echo "üìñ NEXT STEPS:"
              echo "1. Download the artifacts from this build"
              echo "2. Test installation on Raspberry Pi 3+"
              echo "3. Update GitHub releases (manual step)"
              echo "4. Deploy using Ansible (see RASPBERRY_INSTALLATION.md)"
              echo ""
              echo "üîß MANUAL TESTING:"
              echo "1. Copy .deb file to Raspberry Pi"
              echo "2. Run: sudo dpkg -i mthbdeiotclient_*.deb"
              echo "3. Run: sudo apt-get install -f"
              echo "4. Test: mthbdeiotclient"
              echo ""
              echo "üìã ARTIFACT DOWNLOAD:"
              echo "- Go to this build's summary page"
              echo "- Download '$(artifactName)' artifact"
              echo "- Extract and use the .deb file"
              echo ""
              echo "=========================================="
            displayName: "Build Summary & Next Steps"
